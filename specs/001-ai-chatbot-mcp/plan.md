# Implementation Plan: AI-Powered Todo Chatbot

**Branch**: `001-ai-chatbot-mcp` | **Date**: 2026-01-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-ai-chatbot-mcp/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Build an AI-powered conversational interface for managing todo tasks through natural language. Users interact with a chatbot that interprets their intent and performs task operations (create, list, complete, delete, update) via MCP (Model Context Protocol) tools. The system uses a stateless architecture where all conversation and task state is persisted to a PostgreSQL database, enabling horizontal scaling and resilience. The AI agent (OpenAI Agents SDK) invokes standardized MCP tools to interact with the task management backend, providing a natural language interface over existing CRUD operations from Phase I/II.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript/Node.js 18+ (frontend)
**Primary Dependencies**:
- Backend: FastAPI, OpenAI Agents SDK, Official MCP SDK, SQLModel, asyncpg
- Frontend: Next.js, OpenAI ChatKit, React
**Storage**: Neon Serverless PostgreSQL (tasks, conversations, messages tables)
**Testing**: pytest (backend), Jest/React Testing Library (frontend)
**Target Platform**: Web application (serverless-compatible backend, browser-based frontend)
**Project Type**: Web (frontend + backend)
**Performance Goals**:
- 95% of chat requests under 3 seconds response time
- Support 100 concurrent users
- AI intent interpretation 90% accuracy
**Constraints**:
- Stateless server architecture (no in-memory session state)
- Each request fetches conversation history from database
- AI API latency (typically 1-2 seconds per request)
- Database connection pooling required for serverless
**Scale/Scope**:
- Expected: 100-1000 users
- ~10,000 tasks per user maximum
- ~1,000 messages per conversation maximum
- 5 MCP tools (add_task, list_tasks, complete_task, delete_task, update_task)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Spec-Driven Development ✅
- [x] Specification written and approved (spec.md complete)
- [x] Plan being generated from specification (this file)
- [x] Tasks will be broken down from plan (/sp.tasks next)
- [x] Implementation will be generated by Claude Code
- [x] No manual coding planned

**Status**: PASS - Following strict spec-driven workflow

### II. Test-First ✅
- [x] Tests will be written before implementation
- [x] Red-Green-Refactor cycle will be enforced
- [x] Test coverage for all MCP tools
- [x] Integration tests for chat endpoint
- [x] Contract tests for API

**Status**: PASS - TDD approach planned for all components

### III. Incremental Evolution ✅
- [x] Phase III builds on Phase I/II (existing task CRUD operations)
- [x] Backward compatible with existing task management
- [x] Independently deployable
- [x] Delivers working value (conversational task management)

**Status**: PASS - Proper phase evolution, builds on existing foundation

### IV. Reusable Intelligence ⚠️
- [ ] Agent Skills for repeatable workflows (not yet created)
- [ ] Subagents for complex tasks (not yet created)
- [x] MCP tools are reusable abstractions
- [x] Intelligence artifacts will be documented

**Status**: PARTIAL - MCP tools provide reusability, but no custom Agent Skills yet. This is acceptable for Phase III as MCP tools themselves are the reusable intelligence pattern.

### V. Clean Code Architecture ✅
- [x] Clear separation: models (SQLModel), services (MCP tools), API (FastAPI), UI (ChatKit)
- [x] Single Responsibility: Each MCP tool handles one operation
- [x] Dependency Inversion: AI agent depends on MCP tool abstractions
- [x] Clear project structure: /backend and /frontend separation
- [x] Self-documenting code with minimal comments

**Status**: PASS - Clean architecture planned

### VI. Cloud-Native Standards ⚠️
- [ ] Containerization (Docker) - planned for Phase IV
- [ ] Kubernetes deployment - planned for Phase IV
- [x] Stateless architecture (database-backed state)
- [x] Observability (structured logs planned)
- [ ] Infrastructure as Code - planned for Phase IV

**Status**: PARTIAL - Stateless architecture meets cloud-native principles, but containerization deferred to Phase IV per constitution. This is acceptable as Phase III focuses on AI integration.

### VII. AI-Native Integration ✅
- [x] Conversational interface via OpenAI Agents SDK
- [x] MCP SDK for standardized tool protocol
- [x] Natural language task management
- [x] Context-aware responses
- [x] Graceful error handling

**Status**: PASS - Core AI-native integration as specified

### Overall Gate Status: ✅ PASS

**Justification for Partial Compliance**:
- Reusable Intelligence (IV): MCP tools themselves are the reusable intelligence pattern for this phase. Custom Agent Skills will be developed in later phases as patterns emerge.
- Cloud-Native Standards (VI): Containerization and Kubernetes are explicitly scoped for Phase IV per constitution. Phase III focuses on AI integration with stateless architecture that prepares for cloud deployment.

## Project Structure

### Documentation (this feature)

```text
specs/001-ai-chatbot-mcp/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
│   ├── chat-api.yaml    # OpenAPI spec for chat endpoint
│   └── mcp-tools.yaml   # MCP tool definitions
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── task.py           # Task entity (from Phase I/II)
│   │   ├── conversation.py   # Conversation entity (new)
│   │   └── message.py        # Message entity (new)
│   ├── services/
│   │   ├── task_service.py   # Task CRUD operations (from Phase I/II)
│   │   └── chat_service.py   # Chat orchestration (new)
│   ├── mcp/
│   │   ├── server.py         # MCP server implementation (new)
│   │   └── tools/            # MCP tool implementations (new)
│   │       ├── add_task.py
│   │       ├── list_tasks.py
│   │       ├── complete_task.py
│   │       ├── delete_task.py
│   │       └── update_task.py
│   ├── agents/
│   │   └── todo_agent.py     # OpenAI Agents SDK integration (new)
│   ├── api/
│   │   ├── routes/
│   │   │   ├── tasks.py      # Task CRUD endpoints (from Phase I/II)
│   │   │   └── chat.py       # Chat endpoint (new)
│   │   └── dependencies.py   # FastAPI dependencies
│   └── main.py               # FastAPI application entry
├── tests/
│   ├── unit/
│   │   ├── test_mcp_tools.py
│   │   ├── test_chat_service.py
│   │   └── test_todo_agent.py
│   ├── integration/
│   │   ├── test_chat_endpoint.py
│   │   └── test_mcp_server.py
│   └── contract/
│       └── test_chat_api_contract.py
├── alembic/                  # Database migrations
│   └── versions/
│       └── 003_add_conversations_messages.py
├── pyproject.toml
└── README.md

frontend/
├── src/
│   ├── app/
│   │   ├── page.tsx          # Home page (from Phase II)
│   │   └── chat/
│   │       └── page.tsx      # Chat interface (new)
│   ├── components/
│   │   ├── TaskList.tsx      # Task list component (from Phase II)
│   │   └── ChatInterface.tsx # ChatKit integration (new)
│   ├── services/
│   │   ├── taskApi.ts        # Task API client (from Phase II)
│   │   └── chatApi.ts        # Chat API client (new)
│   └── types/
│       ├── task.ts           # Task types (from Phase II)
│       └── chat.ts           # Chat types (new)
├── tests/
│   └── components/
│       └── ChatInterface.test.tsx
├── package.json
├── tsconfig.json
└── next.config.js
```

**Structure Decision**: Web application structure (Option 2) selected because this is a full-stack feature with both frontend (OpenAI ChatKit UI) and backend (FastAPI + MCP server + AI agent). The backend extends the existing Phase I/II task management system with new conversational capabilities. Frontend adds a new chat interface alongside existing task management UI.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations requiring justification. Partial compliance items are within constitutional guidelines for Phase III scope.

## Phase 0: Research & Technical Decisions

*See [research.md](./research.md) for detailed findings*

### Research Areas

1. **OpenAI Agents SDK Integration**
   - How to structure agent with MCP tool access
   - Conversation history management patterns
   - Error handling and retry strategies

2. **MCP Server Implementation**
   - Official MCP SDK usage patterns
   - Tool definition and registration
   - Stateless tool execution with database access

3. **Stateless Architecture Patterns**
   - Conversation history retrieval strategies
   - Database connection pooling for serverless
   - Session management without in-memory state

4. **OpenAI ChatKit Integration**
   - Frontend setup and configuration
   - Domain allowlist requirements
   - Message streaming vs. request-response

5. **Database Schema Design**
   - Conversation and message table structure
   - Indexing strategy for performance
   - Migration from Phase I/II schema

## Phase 1: Design Artifacts

*Detailed design documentation generated in this phase*

### Data Model
See [data-model.md](./data-model.md) for complete entity definitions, relationships, and validation rules.

### API Contracts
See [contracts/](./contracts/) directory for:
- `chat-api.yaml`: OpenAPI specification for chat endpoint
- `mcp-tools.yaml`: MCP tool definitions and schemas

### Quickstart Guide
See [quickstart.md](./quickstart.md) for setup instructions, environment configuration, and testing procedures.

## Phase 2: Task Breakdown

*Generated by `/sp.tasks` command - not part of this plan*

Tasks will be organized by user story priority (P1, P2, P3) to enable incremental delivery. See [tasks.md](./tasks.md) after running `/sp.tasks`.

## Implementation Notes

### Critical Path
1. Database schema migration (conversations, messages tables)
2. MCP server with 5 tools (add, list, complete, delete, update)
3. OpenAI Agents SDK integration with MCP tools
4. Chat endpoint with stateless conversation management
5. ChatKit frontend integration
6. End-to-end testing

### Risk Mitigation
- **AI Misinterpretation**: Implement confirmation prompts for destructive operations
- **API Cost Overruns**: Add rate limiting and usage monitoring
- **Response Latency**: Optimize database queries, implement connection pooling
- **Conversation Context Limits**: Implement history truncation (last 50 messages)

### Dependencies on Previous Phases
- Phase I/II task CRUD operations must be functional
- Phase I/II database schema must be in place
- Phase I/II authentication system must be operational
- Existing task API endpoints will be reused by MCP tools

### Testing Strategy
- Unit tests for each MCP tool (mock database)
- Integration tests for MCP server (test database)
- Contract tests for chat API (OpenAPI validation)
- End-to-end tests for complete user flows
- Performance tests for concurrent users

### Deployment Considerations
- Environment variables for OpenAI API key, database connection
- Database migration before deployment
- Frontend domain allowlist configuration for ChatKit
- Monitoring for AI API usage and costs
- Error tracking for AI service failures
